<html>

  <head>

<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous">
</script> 


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>

<!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css"> -->
<script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>

<script>


$( document ).ready(function() {


  //Init firebase
  var config = {
    apiKey: "AIzaSyCvVMjlA_Gsh2xqukgSNN5AdFevJjCv9lU",
    authDomain: "bps-scorer.firebaseapp.com",
    databaseURL: "https://bps-scorer.firebaseio.com",
    projectId: "bps-scorer",
    storageBucket: "bps-scorer.appspot.com",
    messagingSenderId: "473750220771"
  };
  firebase.initializeApp(config);

  // Get a reference to the database service
  database = firebase.database();
  var dataList = [];
  //retrieve current scores and attach listener

  // firebase.database().ref('/bps-scorer/').on('value', function(snapshot) {

  //   $("#scoreTable").DataTable().destroy();
  //   snapshot.forEach(function(childSnapshot) {
  //       var childData = childSnapshot.val();
  //       console.log("child")
  //       console.log(childData);
  //       dataList.push(childData);

  //   });
  //   //Construct and show datatable
  //   // buildHtmlTable("#scoreTable", dataList);
  //   // CreateTableFromJSON(dataList);
  // });


  firebase.database().ref('/bps-scorer/').once('value').then(function(snapshot) {
    console.log("hello there!");

    snapshot.forEach(function(childSnapshot) {
        var childData = childSnapshot.val();
        // console.log("child")
        // console.log(childData);
        dataList.push(childData);

    });
    //Construct and show datatable
    // buildHtmlTable("#scoreTable", dataList);
    CreateTableFromJSON(dataList);
  });

});

function CreateTableFromJSON(dataList) {
  //delete older table first

    // console.log("dataList");
    // console.log(dataList);

    g_dataList = dataList;

    for(var i=0 ; i< dataList.length; i++ ){

      dataList[i] = $.map(g_dataList[i], function(el) { return el });
      dataList[i].splice(1,1)
    }


    $('#scoreTable').DataTable( {
        data: dataList,
        columns: [
            { title: "Bus Id" },
          //  { title: "csvtext" },
            { title: "Maximum Route Distance" },
            { title: "Organization" },
            { title: "Total Distance Travelled" }
        ],
        "order": [[ 3, "desc" ]]

    } );

    //     $('#scoreTable').DataTable( {
    //     "order": [[ 3, "desc" ]]
    // } );

        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        // var divContainer = document.getElementByTag("body");
        // divContainer.integritynerHTML = "";
        // divContainer.appendChild(table);
    }



function writeUserData(orgName, csvtext, bestRouteID, totalDistance, maxDistRoute) {

  //Change this: https://console.firebase.google.com/project/bps-scorer/database/rules if facing security issues
  // {
  // "rules": {
  //   ".read": true,
  //   ".write": true
  // }
  // }

  //update table

  firebase.database().ref().child('bps-scorer').push({
    orgName: orgName,
    csvtext: csvtext,
    bestRouteID: bestRouteID,
    totalDistance : totalDistance,
    maxDistRoute: maxDistRoute
  }).then(function(snapshot){
    console.log("hogaya!");

    //read data to update table again

    firebase.database().ref('/bps-scorer/').once('value').then(function(snapshot) {
    console.log("hello there!");
    //new data list
    var dataList =[]
    snapshot.forEach(function(childSnapshot) {
        var childData = childSnapshot.val();
        console.log("child")
        console.log(childData);
        dataList.push(childData);

    });
    //Construct and show datatable
    // buildHtmlTable("#scoreTable", dataList);
    $('#scoreTable').dataTable().fnDestroy();
    CreateTableFromJSON(dataList);
  });
  });

}

</script>

 <script>

  //ref: https://mounirmesselmeni.github.io/2012/11/20/reading-csv-file-with-javascript-and-html5-file-api/

  function handleFiles(files) {
      // Check for the various File API support.
      if (window.FileReader) {
          // FileReader are supported.
          getAsText(files[0]);
      } else {
          alert('FileReader are not supported in this browser.');
      }
    }

    function getAsText(fileToRead) {
      var reader = new FileReader();
      // Read file into memory as UTF-8      
      reader.readAsText(fileToRead);
      // Handle errors load
      reader.onload = loadHandler;
      reader.onerror = errorHandler;
    }

    function loadHandler(event) {
      var csv = event.target.result;
      processData(csv);
    }

    function processData(csv) {
        var allTextLines = csv.split(/\r\n|\n/);
        var lines = [];
        for (var i=0; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(';');
                var tarr = [];
                for (var j=0; j<data.length; j++) {
                    tarr.push(data[j]);
                }
                lines.push(tarr);
        }
      // console.log(lines);
      compute(lines,csv);
    }

    function errorHandler(evt) {
      if(evt.target.error.name == "NotReadableError") {
          alert("Canno't read file !");
      }
    }

    function compute(lines,csv){
      var totalDistance=0;
      var maxDistRoute=0;
      var routeDistance =0;
      var busTravellinMaxDist='';

      document.getElementById("progress").innerHTML='<div class="progress"><div id="bar" class="progress-bar" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" width="1%"><span class="sr-only"></span></div></div>'
      for (i=0; i<lines.length-1;i++){
        //now we r in a bus

        if(i%50==0){
          document.getElementById("bar").style="width:"+(i/(lines.length))*100+"%"
          console.log(document.getElementById("bar").style.width);          
        }

        if( i==lines.length-2){
          document.getElementById("bar").style="width:100%"

        }
        var busID1 =Number(lines[i][0].split(',')[0]);
        var lat1 =  Number(lines[i][0].split(',')[1]);
        var lng1 =  Number(lines[i][0].split(',')[2]);

        //bus i+1
        var busID2 = Number(lines[i+1][0].split(',')[0]);
        var lat2 =  Number(lines[i+1][0].split(',')[1]);
        var lng2 =  Number(lines[i+1][0].split(',')[2]);



        if(busID1 == busID2){
          //euclidian as of now, TODO change
          dist = Math.abs(getDistance(lat1,lng1, lat2,lng2));
          // console.log("pairwise is "+ dist);
          //calc distance 
          routeDistance +=dist;

        }

        if(busID1 != busID2 || i==lines.length-2) {
          //new bus
          //add prev route to total
          // console.log("new bus found! at index: "+i);
          // console.log("route distance for prev bus was : "+routeDistance)

          totalDistance+=routeDistance;
          
          // console.log("total distance till now is:"+ totalDistance);

          //update route that travels most
          if(maxDistRoute < routeDistance){
            
            busTravellinMaxDist = busID1;
            maxDistRoute = routeDistance;
          }

          //now reset
          routeDistance= 0;


        }

      }

      //hide progress

      // document.getElementById("progress").innerHTML=""

      // console.log("Total distance travelled by all buses is: " + totalDistance)+ " meters";
      // console.log("Maxiumum distance is travelled by " + busTravellinMaxDist + " which is " + maxDistRoute+ " meters");

      //Add to firebase here


      document.getElementById("result").innerHTML = "Total distance travelled by all buses is: <strong> " + totalDistance+" meters </strong><br>Maxiumum distance is travelled by <strong> bus route  " + busTravellinMaxDist + " </strong> which is " + maxDistRoute+ " meters";

      var orgName = document.getElementById("orgName").value
      writeUserData(orgName, csv , busTravellinMaxDist, totalDistance, maxDistRoute);

      //reset input
      document.getElementById('csvFileInput').value = null;
    }


//ref: https://github.com/janantala/GPS-distance/blob/master/javascript/distance.js
if (typeof(Number.prototype.toRad) === "undefined") 
{
  Number.prototype.toRad = function() 
  {
    return this * Math.PI / 180;
  }
}

function getDistance(lat1, lon1, lat2, lon2) 
{
  var a = 6378137, b = 6356752.314245,  f = 1/298.257223563;
  var L = (lon2-lon1).toRad();
  var U1 = Math.atan((1-f) * Math.tan(lat1.toRad()));
  var U2 = Math.atan((1-f) * Math.tan(lat2.toRad()));
  var sinU1 = Math.sin(U1), cosU1 = Math.cos(U1);
  var sinU2 = Math.sin(U2), cosU2 = Math.cos(U2);

  var lambda = L, lambdaP, iterLimit = 100;
  do 
  {
    var sinLambda = Math.sin(lambda), cosLambda = Math.cos(lambda);
    var sinSigma = Math.sqrt((cosU2*sinLambda) * (cosU2*sinLambda) + (cosU1*sinU2-sinU1*cosU2*cosLambda) * (cosU1*sinU2-sinU1*cosU2*cosLambda));
    if (sinSigma==0) return 0;

    var cosSigma = sinU1*sinU2 + cosU1*cosU2*cosLambda;
    var sigma = Math.atan2(sinSigma, cosSigma);
    var sinAlpha = cosU1 * cosU2 * sinLambda / sinSigma;
    var cosSqAlpha = 1 - sinAlpha*sinAlpha;
    var cos2SigmaM = cosSigma - 2*sinU1*sinU2/cosSqAlpha;
    if (isNaN(cos2SigmaM)) cos2SigmaM = 0;
    var C = f/16*cosSqAlpha*(4+f*(4-3*cosSqAlpha));
    lambdaP = lambda;
    lambda = L + (1-C) * f * sinAlpha * (sigma + C*sinSigma*(cos2SigmaM+C*cosSigma*(-1+2*cos2SigmaM*cos2SigmaM)));
  } while (Math.abs(lambda-lambdaP) > 1e-12 && --iterLimit>0);

  if (iterLimit==0) return NaN

  var uSq = cosSqAlpha * (a*a - b*b) / (b*b);
  var A = 1 + uSq/16384*(4096+uSq*(-768+uSq*(320-175*uSq)));
  var B = uSq/1024 * (256+uSq*(-128+uSq*(74-47*uSq)));
  var deltaSigma = B*sinSigma*(cos2SigmaM+B/4*(cosSigma*(-1+2*cos2SigmaM*cos2SigmaM)-B/6*cos2SigmaM*(-3+4*sinSigma*sinSigma)*(-3+4*cos2SigmaM*cos2SigmaM)));
  var s = b*A*(sigma-deltaSigma);
  
  return s;
}


</script>



  </head>
 
  <body>
<div class="container">

  <div class="page-header">
    <h1>Boston Public Schools Transportation Challenge Leaderboard </h1>      
  </div>

  <div class="row-fluid">
    Add Organization Name:
    <input type="text" class="col-6" id="orgName"><br><br>
  </div>

  <div class="row-fluid">
    <div class="col-6">Please upload result csv file below:</div><br>
    <div class="col-6">
      
            <label class="btn btn-primary">
                Browse 
                <input type="file" style="display: none;" id="csvFileInput" onchange="handleFiles(this.files)" onload="handleFiles(this.files)" accept=".csv">
            </label>
    </div>    
  </div>

  </br>

 <div id="progress" class="row-fluid">
  </div>

  </br>
  <div class="row-fluid">
    <div class="col-12" id="result">
    </div>
  </div>

  <div class="row-fluid">
    <div class="col-6" >Current Score Board</div><br><br>
  </div>

  <table id="scoreTable">
  </table>

</div>


</body>
</html>

