<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="js/path.js"></script>
    <link
      rel="stylesheet" 
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" 
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" 
      crossorigin="anonymous">
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
      crossorigin="anonymous">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous">
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.17.6/clusterize.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handsontable/0.31.2/handsontable.full.min.js"></script>
    <link rel="stylesheet" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.core.min.css">
    <link rel="stylesheet" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.default.min.css">
    <link rel="stylesheet" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.bootstrap.min.css">
    <link rel="stylesheet" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.17.6/clusterize.min.css">
    <link rel="stylesheet" media="screen" href="//cdnjs.cloudflare.com/ajax/libs/handsontable/0.31.2/handsontable.full.min.css">
    <link rel="stylesheet" media="screen" href="css/style.css">
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>Boston Public Schools Transportation Challenge</h1>      
      </div>
      <div class="row-fluid">
        <table style="width:100%;">
          <tr><td><a href="bps-tc-template.xlsx">Download solution <b>template</b></a> (to be filled out by you)</td></tr>
          <tr><td><a href="bps-tc-example.xlsx">Download solution <b>example</b> file</a> (to see an example of the solution format)</td></tr>
          <tr><td><a href="bps-tc-invalid.xlsx">Download <b>invalid</b> solution example file</a> (to see examples of validation errors)</td></tr>
          <tr><td><a href="bps-tc-complete.xlsx">Download a <b>full-scale complete solution</b> file</a> (generated using <a href="https://github.com/Data-Mechanics/bps-simulated-data">bps-simulated-data</a>)</td></tr>
          <tr><td>&nbsp;</td></tr>
          <tr><td>View the source code for this tool <a href="https://github.com/Data-Mechanics/bps-challenge-score">on GitHub</a></td></tr>
        </table>
        <br/>
      </div>
      <!--div class="row-fluid">
        Add Organization Name:
        <input type="text" class="col-6" id="orgName"><br><br>
      </div>
      <div class="row-fluid">
        <div class="col-6">Please upload result csv file below:</div>
        <br/>
        <div class="col-6">
          <label class="btn btn-primary">
            Browse 
            <input type="file" style="display: none;" id="csvFileInput" 
                   onchange="handleFiles(this.files)"
                   onload="handleFiles(this.files)" accept=".csv">
          </label>
        </div>    
      </div>
      </br>
      <div id="progress" class="row-fluid"></div>
      </br>
      <div class="row-fluid">
        <div class="col-12" id="result"></div>
      </div>
      <div class="row-fluid">
        <div class="col-6" ><h3>Current Score Board</h3></div>
        <br/><br/>
      </div>
      <table id="scoreTable"></table-->
      <div class="row-fluid">
        <div>
          <div id="drop">Drag and drop Excel<br/>solution file here.</div>
        </div>
        <div id="simulation_view" style="display:none;">
          <button onclick="simulate(workbook_js);">Simulation</button>
          <br/><br/>
          <div class="clusterize">
            <table>
              <thead>
                <tr>
                  <th style="font-weight:normal;">Click <b>Simulate</b> above to begin validating and evaluating your data.</th>
                </tr>
              </thead>
            </table>
            <br/>
            <div id="scrollArea" class="clusterize-scroll">
              <table>
                <tbody id="contentArea" class="clusterize-content">
                  <!--tr class="clusterize-no-data">
                    <td style="text-align:left; text-decoration:underline;"><b>Simulation Progress and Results</b></td>
                  </tr-->
                </tbody>
              </table>
            </div>
          </div>
          <br/>
        </div>
        <div id="spreadsheet_view"  style="display:none;">
          <div id="buttons"></div>
          <div id="hot" style="overflow:scroll" class="handsontable"></div>
        </div>
      </div>
    </div>
    <script src="js/data.structs.js"></script>
    <script src="js/xlsx.full.min.js"></script>
    <script src="js/dropsheet.js"></script>
    <script>
var sheets = {'Buses':true, 'Stop-Assignments':true, 'Routes':true};

var _target = document.getElementById('drop');
var spinner;
var _workstart = function() { spinner = new Spinner().spin(_target); }
var _workend = function() {
  spinner.stop();
  $('#simulation_view').show();
  $('#spreadsheet_view').show();  
}
var _badfile = function() { alertify.alert('This file does not appear to be a valid Excel file.', function(){}); };
var _pending = function() { alertify.alert('Please wait until the current file is processed.', function(){}); };
var _large = function(len, cb) { alertify.confirm("This file is " + (len/(1024*1024)).toFixed(2) + " MB and may take a few moments. Your browser may lock up during this process. Continue?", cb); };
var _failed = function(e) { alertify.alert('This format is not supported.', function(){}); };

var boldRenderer = function (instance, td, row, col, prop, value, cellProperties) {
  Handsontable.TextCell.renderer.apply(this, arguments);
  $(td).css({'font-weight': 'bold'});
};

var make_buttons = function(sheetnames, cb) {
  var $buttons = $('#buttons');
  $buttons.html("");
  sheetnames.forEach(function(s,idx) {
    if (s in sheets) {
      var button= $('<button/>').attr({ type:'button', name:'btn' +idx, text:s });
      button.append(s);
      button.click(function() { cb(idx); });
      $buttons.append(button);
    }
  });
};

var _onsheet = function(json, cols, sheetnames, select_sheet_cb) {
  make_buttons(sheetnames, select_sheet_cb);
  calculateSize();
  if (!json) json = []; /* add header row for table */
  json.unshift(function(head){var o = {}; for(i=0;i!=head.length;++i) o[head[i]] = head[i]; return o;}(cols));
  calculateSize();
  $("#hot").handsontable({
    data: json,
    startRows: 5, startCols: 3, fixedRowsTop: 1,
    stretchH: 'all',
    rowHeaders: true,
    columns: cols.map(function(x) { return {data:x}; }),
    colHeaders: cols.map(function(x,i) { return XLS.utils.encode_col(i); }),
    cells: function (r,c,p) { if(r === 0) this.renderer = boldRenderer; },
    width: function () { return availableWidth; },
    height: function () { return availableHeight; },
    stretchH: 'all'
  });
};

var $window, availableWidth, availableHeight;
var calculateSize = function () {
  availableWidth = Math.max($('#drop').width(), 600);
  availableHeight = Math.max($window.height() - 250, 400);
};
$(document).ready(function() {
  $window = $(window);
  $window.on('resize', calculateSize);
});
var workbook_js = DropSheet({
  drop: _target,
  on: { workstart: _workstart, workend: _workend, sheet: _onsheet },
  errors: { badfile: _badfile, pending: _pending, failed: _failed, large: _large }
}, sheets);
//$("#hot").hide();
var clusterize = new Clusterize({scrollId:'scrollArea', contentId:'contentArea'});
    </script>
    <script src="js/simulation.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
  </body>
</html>